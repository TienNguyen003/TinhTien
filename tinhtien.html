<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Chi ti√™u ƒêa nƒÉng</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --p: #2563eb;
        --s: #22c55e;
        --d: #ef4444;
        --bg: #f1f5f9;
      }
      body {
        font-family: "Roboto Slab";
        background: var(--bg);
        padding: 20px;
      }
      .container {
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      }

      /* Ph·∫ßn c·∫•u h√¨nh */
      .config-section {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
        border: 1px solid #e2e8f0;
      }
      .config-section h4 {
        margin-top: 0;
        color: #64748b;
        font-size: 14px;
      }

      .input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        box-sizing: border-box;
        font-family: inherit;
      }
      .expense-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }

      button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-family: inherit;
        transition: 0.2s;
      }
      .btn-add {
        background: #f8fafc;
        border: 1px dashed #cbd5e1;
        width: 100%;
        color: #64748b;
        margin-bottom: 20px;
      }
      .btn-main {
        background: var(--p);
        color: white;
        width: 100%;
        font-size: 16px;
        height: 50px;
      }
      .btn-sync {
        background: var(--s);
        color: white;
        margin-top: 10px;
        width: 100%;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 30px;
      }
      .stat-card {
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        color: white;
      }
      .bg-blue {
        background: var(--p);
      }
      .bg-green {
        background: var(--s);
      }
      .bg-indigo {
        background: #4f46e5;
      }
      .stat-card b {
        font-size: 20px;
        display: block;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 30px;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      th {
        background: #f8fafc;
        color: #64748b;
      }

      #detailModal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background: white;
        margin: 10% auto;
        padding: 25px;
        border-radius: 12px;
        max-width: 500px;
        position: relative;
      }
      .close-modal {
        position: absolute;
        right: 20px;
        top: 15px;
        font-size: 24px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="config-section">
        <h4>‚öôÔ∏è C·∫•u h√¨nh Google Sheets (D√†nh cho ng∆∞·ªùi d√πng kh√°c)</h4>
        <input
          type="text"
          id="googleScriptUrl"
          placeholder="D√°n Web App URL t·ª´ Google Script v√†o ƒë√¢y ƒë·ªÉ ƒë·ªìng b·ªô..."
          onchange="saveConfig()"
        />
        <small style="color: #94a3b8">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u t·∫°i tr√¨nh duy·ªát n√†y. Nh·∫•n 'ƒê·ªìng b·ªô' ƒë·ªÉ ƒë·∫©y l√™n Sheets.</small>
      </div>

      <h2>üìí Qu·∫£n l√Ω Chi ti√™u</h2>

      <div class="input-group">
        <div>
          <label>Th√°ng/NƒÉm</label>
          <input type="month" id="monthYear" />
        </div>
        <div>
          <label>Thu nh·∫≠p (VNƒê)</label>
          <input type="number" id="income" placeholder="VD: 15000000" />
        </div>
      </div>

      <div id="expenseList">
        <div class="expense-row">
          <input type="text" placeholder="T√™n kho·∫£n chi" class="ex-name" />
          <input type="number" placeholder="S·ªë ti·ªÅn" class="ex-amount" />
          <button onclick="this.parentElement.remove()" style="background: #fee2e2; color: var(--d)">‚úï</button>
        </div>
      </div>
      <button class="btn-add" onclick="addExpenseRow()">+ Th√™m kho·∫£n chi</button>

      <button class="btn-main" onclick="processData()">üìä L∆∞u v√†o m√°y n√†y</button>
      <button class="btn-sync" onclick="syncToGoogle()">‚òÅÔ∏è ƒê·ªìng b·ªô l√™n Google Sheets</button>

      <div class="summary-grid">
        <div class="stat-card bg-blue"><small>D∆∞ th√°ng ch·ªçn</small><b id="monthlyRemain">0 ‚Ç´</b></div>
        <div class="stat-card bg-green">
          <small>T√≠ch l≈©y nƒÉm <span id="displayYear"></span></small><b id="yearlyRemain">0 ‚Ç´</b>
        </div>
        <div class="stat-card bg-indigo"><small>T·ªïng t√≠ch l≈©y</small><b id="totalRemain">0 ‚Ç´</b></div>
      </div>

      <h3>üìú L·ªãch s·ª≠</h3>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Th√°ng</th>
            <th>Thu nh·∫≠p</th>
            <th>C√≤n d∆∞</th>
            <th>H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="detailModal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle">Chi ti·∫øt</h3>
        <table style="width: 100%">
          <thead>
            <tr>
              <th>Kho·∫£n chi</th>
              <th>S·ªë ti·ªÅn</th>
            </tr>
          </thead>
          <tbody id="modalBody"></tbody>
        </table>
        <div id="modalTotal" style="text-align: right; margin-top: 10px; font-weight: bold"></div>
      </div>
    </div>

    <script>
      // Kh·ªüi t·∫°o
      window.onload = () => {
        const savedUrl = localStorage.getItem("google_script_url");
        if (savedUrl) document.getElementById("googleScriptUrl").value = savedUrl;

        document.getElementById("monthYear").value = new Date().toISOString().slice(0, 7);
        renderHistory();
      };

      function saveConfig() {
        localStorage.setItem("google_script_url", document.getElementById("googleScriptUrl").value);
      }

      function addExpenseRow() {
        const div = document.createElement("div");
        div.className = "expense-row";
        div.innerHTML = `<input type="text" placeholder="T√™n kho·∫£n chi" class="ex-name">
                         <input type="number" placeholder="S·ªë ti·ªÅn" class="ex-amount">
                         <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:var(--d)">‚úï</button>`;
        document.getElementById("expenseList").appendChild(div);
      }

      function processData() {
        const date = document.getElementById("monthYear").value;
        const income = parseFloat(document.getElementById("income").value) || 0;
        const nameInputs = document.querySelectorAll(".ex-name");
        const amountInputs = document.querySelectorAll(".ex-amount");

        let items = [];
        let totalExp = 0;
        nameInputs.forEach((input, i) => {
          const amount = parseFloat(amountInputs[i].value) || 0;
          if (amount > 0) {
            items.push({ name: input.value || "Kh√°c", amount });
            totalExp += amount;
          }
        });

        const remain = income - totalExp;
        let history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        const idx = history.findIndex((item) => item.date === date);
        const entry = { date, income, totalExp, remain, items };

        if (idx > -1) history[idx] = entry;
        else history.push(entry);
        history.sort((a, b) => new Date(a.date) - new Date(b.date));

        localStorage.setItem("expense_detail_data", JSON.stringify(history));
        renderHistory();
        alert("ƒê√£ l∆∞u v√†o b·ªô nh·ªõ tr√¨nh duy·ªát!");
      }

      async function syncToGoogle() {
        const url = document.getElementById("googleScriptUrl").value;
        if (!url) return alert("Vui l√≤ng ƒëi·ªÅn Web App URL!");

        const history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        if (history.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ƒë·ªìng b·ªô!");

        if (!confirm(`B·∫°n mu·ªën g·ª≠i t·∫•t c·∫£ ${history.length} b·∫£n ghi l√™n Google Sheets?`)) return;

        let successCount = 0;
        for (const entry of history) {
          try {
            await fetch(url, {
              method: "POST",
              mode: "no-cors",
              body: JSON.stringify(entry),
              headers: { "Content-Type": "application/json" },
            });
            successCount++;
          } catch (e) {
            console.error("L·ªói g·ª≠i b·∫£n ghi:", entry.date, e);
          }
        }
        alert(`ƒê√£ ƒë·ªìng b·ªô th√†nh c√¥ng ${successCount} th√°ng l√™n Google Sheets!`);
      }

      function renderHistory() {
        const history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        const tbody = document.querySelector("#historyTable tbody");
        const selectedYear = document.getElementById("monthYear").value.split("-")[0];
        document.getElementById("displayYear").innerText = selectedYear;
        tbody.innerHTML = "";

        let totalAcc = 0;
        let yearlyAcc = 0;
        history.forEach((data, index) => {
          totalAcc += data.remain;
          if (data.date.startsWith(selectedYear)) yearlyAcc += data.remain;
          tbody.innerHTML += `<tr>
                <td><b>${data.date}</b></td>
                <td>${data.income.toLocaleString()}</td>
                <td style="color:${data.remain >= 0 ? "green" : "red"}"><b>${data.remain.toLocaleString()}</b></td>
                <td><button class="btn-view" onclick="showDetail(${index})">üëÅ Chi ti·∫øt</button></td>
            </tr>`;
        });
        document.getElementById("totalRemain").innerText = totalAcc.toLocaleString() + " ‚Ç´";
        document.getElementById("yearlyRemain").innerText = yearlyAcc.toLocaleString() + " ‚Ç´";
      }

      function showDetail(index) {
        const history = JSON.parse(localStorage.getItem("expense_detail_data"));
        const data = history[index];
        document.getElementById("modalTitle").innerText = "Chi ti·∫øt: " + data.date;
        const modalBody = document.getElementById("modalBody");
        modalBody.innerHTML = "";
        data.items.forEach((item) => {
          modalBody.innerHTML += `<tr><td>${item.name}</td><td>${item.amount.toLocaleString()} ‚Ç´</td></tr>`;
        });
        document.getElementById("modalTotal").innerText = "T·ªïng chi: " + data.totalExp.toLocaleString() + " ‚Ç´";
        document.getElementById("detailModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("detailModal").style.display = "none";
      }

      // Logic l√†m m·ªõi √¥ nh·∫≠p khi ƒë·ªïi th√°ng
      document.getElementById("monthYear").addEventListener("change", function () {
        const history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        const existingData = history.find((item) => item.date === this.value);
        const expenseList = document.getElementById("expenseList");
        const incomeInput = document.getElementById("income");

        if (existingData) {
          incomeInput.value = existingData.income;
          expenseList.innerHTML = "";
          existingData.items.forEach((item) => {
            const div = document.createElement("div");
            div.className = "expense-row";
            div.innerHTML = `<input type="text" class="ex-name" value="${item.name}">
                                 <input type="number" class="ex-amount" value="${item.amount}">
                                 <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:var(--d)">‚úï</button>`;
            expenseList.appendChild(div);
          });
        } else {
          incomeInput.value = "";
          expenseList.innerHTML = `<div class="expense-row"><input type="text" class="ex-name"><input type="number" class="ex-amount"></div>`;
        }
        renderHistory();
      });
    </script>
  </body>
</html>
