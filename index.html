<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Chi ti√™u ƒêa nƒÉng</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --p: #2563eb;
        --s: #22c55e;
        --d: #ef4444;
        --bg: #f1f5f9;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Roboto Slab", serif;
        background: var(--bg);
        padding: 10px;
        margin: 0;
      }
      .container {
        max-width: 900px;
        margin: 10px auto;
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      }

      /* Ph·∫ßn c·∫•u h√¨nh */
      .config-section {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
        border: 1px solid #e2e8f0;
      }
      .config-section h4 {
        margin-top: 0;
        color: #64748b;
        font-size: 14px;
      }

      /* Grid Input */
      .input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-family: inherit;
        font-size: 16px; /* Tr√°nh zoom tr√™n iOS */
      }
      .expense-row {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      .expense-row input:first-child {
        flex: 2;
      }
      .expense-row input:nth-child(2) {
        flex: 1.5;
      }

      /* Buttons */
      button {
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-family: inherit;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn-add {
        background: #f1f5f9;
        border: 1px dashed #cbd5e1;
        width: 100%;
        color: #64748b;
        margin-bottom: 20px;
      }
      .btn-main {
        background: var(--p);
        color: white;
        width: 100%;
        font-size: 16px;
        margin-bottom: 10px;
      }
      .btn-sync {
        background: var(--s);
        color: white;
        width: 100%;
      }

      /* Th·ªëng k√™ Card */
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 30px;
      }
      .stat-card {
        padding: 15px 10px;
        border-radius: 12px;
        text-align: center;
        color: white;
      }
      .bg-blue {
        background: var(--p);
      }
      .bg-green {
        background: var(--s);
      }
      .bg-indigo {
        background: #4f46e5;
      }
      .stat-card small {
        display: block;
        font-size: 11px;
        opacity: 0.9;
        margin-bottom: 5px;
      }
      .stat-card b {
        font-size: 14px;
        word-break: break-all;
      }

      /* L·ªãch s·ª≠ Table */
      .table-container {
        overflow-x: auto;
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        /* min-width: 500px;  */
      }
      th,
      td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
      }
      th {
        background: #f8fafc;
        color: #64748b;
      }
      .btn-view {
        background: #e0e7ff;
        color: #4338ca;
        padding: 6px 10px;
        font-size: 12px;
      }

      /* Modal */
      #detailModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        padding: 15px;
      }
      .modal-content {
        background: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 12px;
        max-width: 500px;
        width: 100%;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
      }
      .close-modal {
        position: absolute;
        right: 15px;
        top: 10px;
        font-size: 28px;
        cursor: pointer;
      }

      /* --- RESPONSIVE CHO ƒêI·ªÜN THO·∫†I --- */
      @media (max-width: 600px) {
        .container {
          padding: 15px;
          border-radius: 0;
          margin: 0;
        }
        .input-group {
          grid-template-columns: 1fr;
        } /* Chuy·ªÉn nh·∫≠p li·ªáu th√†nh 1 c·ªôt */

        .summary-grid {
          grid-template-columns: 1fr; /* Card th·ªëng k√™ x·∫øp ch·ªìng l√™n nhau */
        }
        .stat-card {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px;
        }
        .stat-card small {
          margin-bottom: 0;
          font-size: 14px;
        }
        .stat-card b {
          font-size: 18px;
        }

        .expense-row {
          flex-wrap: wrap;
        }
        .expense-row input {
          flex: 1 1 40% !important;
        }
        .expense-row button {
          width: 40px;
        }

        h2 {
          font-size: 20px;
        }
      }

      /* Modal xem Sheets */
      #sheetsModal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
      }
      .sheets-content {
        background: white;
        margin: 2% auto;
        padding: 10px;
        border-radius: 12px;
        width: 95%;
        max-width: 1200px;
        height: 85vh;
        position: relative;
      }
      .close-sheets {
        color: black;
        font-size: 30px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div>
        <div class="config-section">
          <h4>‚öôÔ∏è C·∫•u h√¨nh Google Sheets</h4>
          <input type="text" id="googleScriptUrl" placeholder="D√°n Web App URL v√†o ƒë√¢y..." onchange="saveConfig()" />
          <small style="display: block; margin-top: 5px; color: #94a3b8">Nh·∫•n 'ƒê·ªìng b·ªô' ƒë·ªÉ ƒë·∫©y l√™n Sheets.</small>
        </div>

        <h2>üìí Qu·∫£n l√Ω Chi ti√™u</h2>

        <div class="input-group">
          <div>
            <label style="font-size: 14px; color: #64748b">Th√°ng/NƒÉm</label>
            <input type="month" id="monthYear" />
          </div>
          <div>
            <label style="font-size: 14px; color: #64748b">Thu nh·∫≠p (VNƒê)</label>
            <input type="number" id="income" placeholder="VD: 15000000" />
          </div>
        </div>

        <div id="expenseList">
          <div class="expense-row">
            <input type="text" placeholder="T√™n kho·∫£n chi" class="ex-name" />
            <input type="number" placeholder="S·ªë ti·ªÅn" class="ex-amount" />
            <button onclick="this.parentElement.remove()" style="background: #fee2e2; color: var(--d)">‚úï</button>
          </div>
        </div>

        <button class="btn-add" onclick="addExpenseRow()">+ Th√™m kho·∫£n chi</button>
        <div style="display: flex;">
          <button class="btn-main" style="height: 40px" onclick="processData()">üìä L∆∞u v√†o m√°y n√†y</button>
          <button class="btn-sync" style="height: 40px; margin-left: 10px" onclick="syncToGoogle()">‚òÅÔ∏è ƒê·ªìng b·ªô l√™n Google Sheets</button>
          <button onclick="openSheetsModal()" style="background: #64748b; color: white; width: 100%; height: 40px; margin-left: 10px">
            üëÅÔ∏è Xem b·∫£ng t√≠nh tr·ª±c ti·∫øp
          </button>
        </div>

        <div class="summary-grid">
          <div class="stat-card bg-blue"><small>D∆∞ th√°ng ch·ªçn</small><b id="monthlyRemain">0 ‚Ç´</b></div>
          <div class="stat-card bg-green">
            <small>T√≠ch l≈©y nƒÉm <span id="displayYear"></span></small><b id="yearlyRemain">0 ‚Ç´</b>
          </div>
          <div class="stat-card bg-indigo"><small>T·ªïng t√≠ch l≈©y</small><b id="totalRemain">0 ‚Ç´</b></div>
        </div>

        <h3>üìú L·ªãch s·ª≠</h3>
        <div class="table-container">
          <table id="historyTable">
            <thead>
              <tr>
                <th>Th√°ng</th>
                <th>Thu nh·∫≠p</th>
                <th>C√≤n d∆∞</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="detailModal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle" style="margin-top: 0">Chi ti·∫øt</h3>
        <table style="width: 100%">
          <thead>
            <tr>
              <th>Kho·∫£n chi</th>
              <th>S·ªë ti·ªÅn</th>
              <th>Ti·ªÅn c√≤n l·∫°i</th>
            </tr>
          </thead>
          <tbody id="modalBody"></tbody>
        </table>
        <div
          id="modalTotal"
          style="text-align: right; margin-top: 15px; font-weight: bold; font-size: 16px; line-height: 1.6"
        ></div>
      </div>
    </div>

    <div id="sheetsModal">
      <div class="sheets-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px">
          <h4 style="margin: 0 0 10px 0; color: #1e293b">B·∫£ng t√≠nh Google Sheets</h4>
          <span class="close-sheets" onclick="closeSheetsModal()">&times;</span>
        </div>
        <iframe
          src="https://docs.google.com/spreadsheets/d/1SohNVWLW2lZROdtSzfu4R6-jbSLA8RD4_vOp2JhatCs/edit?rm=minimal"
          style="width: 100%; height: calc(100% - 40px); border: 1px solid #e2e8f0; border-radius: 8px"
        ></iframe>
      </div>
    </div>

    <script>
      // Gi·ªØ nguy√™n to√†n b·ªô ph·∫ßn script c·ªßa b·∫°n
      window.onload = () => {
        const savedUrl = localStorage.getItem("google_script_url");
        if (savedUrl) document.getElementById("googleScriptUrl").value = savedUrl;
        document.getElementById("monthYear").value = new Date().toISOString().slice(0, 7);
        renderHistory();
      };

      function saveConfig() {
        localStorage.setItem("google_script_url", document.getElementById("googleScriptUrl").value);
      }

      function addExpenseRow() {
        const div = document.createElement("div");
        div.className = "expense-row";
        div.innerHTML = `<input type="text" placeholder="T√™n kho·∫£n chi" class="ex-name">
                         <input type="number" placeholder="S·ªë ti·ªÅn" class="ex-amount">
                         <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:var(--d)">‚úï</button>`;
        document.getElementById("expenseList").appendChild(div);
      }

      function processData() {
        const date = document.getElementById("monthYear").value;
        const income = parseFloat(document.getElementById("income").value) || 0;
        const nameInputs = document.querySelectorAll(".ex-name");
        const amountInputs = document.querySelectorAll(".ex-amount");

        let items = [];
        let totalExp = 0;
        nameInputs.forEach((input, i) => {
          const amount = parseFloat(amountInputs[i].value) || 0;
          if (amount > 0) {
            items.push({ name: input.value || "Kh√°c", amount });
            totalExp += amount;
          }
        });

        const remain = income - totalExp;
        let history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        const idx = history.findIndex((item) => item.date === date);
        const entry = { date, income, totalExp, remain, items };

        if (idx > -1) history[idx] = entry;
        else history.push(entry);
        history.sort((a, b) => new Date(a.date) - new Date(b.date));

        localStorage.setItem("expense_detail_data", JSON.stringify(history));
        renderHistory();
        updateInputsByMonth(date);
        alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
      }

      async function syncToGoogle() {
        const url = document.getElementById("googleScriptUrl").value;
        if (!url) return alert("Vui l√≤ng ƒëi·ªÅn Web App URL!");

        const history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        if (history.length === 0) {
          if (!confirm("L·ªãch s·ª≠ tr·ªëng, b·∫°n c√≥ mu·ªën x√≥a s·∫°ch d·ªØ li·ªáu tr√™n Google Sheets?")) return;
        }

        if (
          !confirm(
            `H·ªá th·ªëng s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán c√≥ tr√™n Sheets b·∫±ng ${history.length} b·∫£n ghi t·ª´ m√°y n√†y. Ti·∫øp t·ª•c?`,
          )
        )
          return;

        try {
          // G·ª≠i to√†n b·ªô m·∫£ng history thay v√¨ g·ª≠i t·ª´ng entry
          await fetch(url, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(history), // G·ª≠i c·∫£ m·∫£ng
            headers: { "Content-Type": "application/json" },
          });
          alert("ƒê√£ ƒë·ªìng b·ªô s·∫°ch s·∫Ω! Sheets hi·ªán t·∫°i ƒë√£ kh·ªõp 100% v·ªõi m√°y n√†y.");
        } catch (e) {
          alert("L·ªói ƒë·ªìng b·ªô: " + e.message);
        }
      }

      function renderHistory() {
        const history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        const tbody = document.querySelector("#historyTable tbody");
        const selectedYear = document.getElementById("monthYear").value.split("-")[0];
        document.getElementById("displayYear").innerText = selectedYear;
        tbody.innerHTML = "";

        let totalAcc = 0;
        let yearlyAcc = 0;
        history.forEach((data, index) => {
          totalAcc += data.remain;
          if (data.date.startsWith(selectedYear)) yearlyAcc += data.remain;
          tbody.innerHTML += `<tr>
                <td><b>${data.date}</b></td>
                <td>${data.income.toLocaleString()}</td>
                <td style="color:${data.remain >= 0 ? "green" : "red"}"><b>${data.remain.toLocaleString()}</b></td>
                <td><button class="btn-view" onclick="showDetail(${index})">üëÅ Xem</button></td>
            </tr>`;
        });
        document.getElementById("totalRemain").innerText = totalAcc.toLocaleString() + " ‚Ç´";
        document.getElementById("yearlyRemain").innerText = yearlyAcc.toLocaleString() + " ‚Ç´";

        // C·∫≠p nh·∫≠t s·ªë d∆∞ th√°ng ƒëang ch·ªçn
        const currentDate = document.getElementById("monthYear").value;
        const currentData = history.find((h) => h.date === currentDate);
        document.getElementById("monthlyRemain").innerText =
          (currentData ? currentData.remain.toLocaleString() : "0") + " ‚Ç´";
      }

      function showDetail(index) {
        const history = JSON.parse(localStorage.getItem("expense_detail_data"));
        const data = history[index];
        document.getElementById("modalTitle").innerText = "Chi ti·∫øt: " + data.date;
        const modalBody = document.getElementById("modalBody");
        modalBody.innerHTML = "";

        // B·∫Øt ƒë·∫ßu t·ª´ s·ªë thu nh·∫≠p ban ƒë·∫ßu
        let runningBalance = data.income;

        data.items.forEach((item) => {
          runningBalance -= item.amount; // Tr·ª´ d·∫ßn t·ª´ng kho·∫£n chi
          modalBody.innerHTML += `
            <tr>
              <td>${item.name}</td>
              <td>${item.amount.toLocaleString()} ‚Ç´</td>
              <td style="color: ${runningBalance >= 0 ? "#64748b" : "red"}">
                ${runningBalance.toLocaleString()} ‚Ç´
              </td>
            </tr>`;
        });

        document.getElementById("modalTotal").innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; text-align: center;">
            <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
              <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Thu nh·∫≠p</div>
              <div style="font-size: 15px; color: var(--p); font-weight: 700;">${data.income.toLocaleString()} ‚Ç´</div>
            </div>
            <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
              <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">T·ªïng chi</div>
              <div style="font-size: 15px; color: var(--d); font-weight: 700;">${data.totalExp.toLocaleString()} ‚Ç´</div>
            </div>
            <div style="grid-column: span 2; background: ${data.remain >= 0 ? "#f0fdf4" : "#fef2f2"}; padding: 12px; border-radius: 8px; border: 1px solid ${data.remain >= 0 ? "#bbf7d0" : "#fecaca"};">
              <div style="font-size: 12px; color: #64748b;">S·ªë d∆∞ cu·ªëi c√πng</div>
              <div style="font-size: 20px; color: ${data.remain >= 0 ? "var(--s)" : "var(--d)"}; font-weight: 800;">
                ${data.remain.toLocaleString()} ‚Ç´
              </div>
            </div>
          </div>
        `;
        document.getElementById("detailModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("detailModal").style.display = "none";
      }

      document.getElementById("monthYear").addEventListener("change", renderHistory);

      // H√†m c·∫≠p nh·∫≠t c√°c √¥ input d·ª±a tr√™n d·ªØ li·ªáu ƒë√£ c√≥ c·ªßa th√°ng ƒë∆∞·ª£c ch·ªçn
      function updateInputsByMonth(selectedDate) {
        const history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        const existingData = history.find((item) => item.date === selectedDate);
        const expenseList = document.getElementById("expenseList");
        const incomeInput = document.getElementById("income");

        if (existingData) {
          // N·∫øu th√°ng n√†y ƒë√£ c√≥ d·ªØ li·ªáu: ƒê·ªï d·ªØ li·ªáu v√†o
          incomeInput.value = existingData.income;
          expenseList.innerHTML = ""; // X√≥a c√°c √¥ tr·ªëng c≈©
          existingData.items.forEach((item) => {
            const div = document.createElement("div");
            div.className = "expense-row";
            div.innerHTML = `
              <input type="text" class="ex-name" value="${item.name}">
              <input type="number" class="ex-amount" value="${item.amount}">
              <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:var(--d)">‚úï</button>`;
            expenseList.appendChild(div);
          });
        } else {
          // N·∫øu th√°ng m·ªõi ho√†n to√†n: ƒê·ªÉ tr·ªëng thu nh·∫≠p v√† hi·ªán 1 h√†ng nh·∫≠p tr·ªëng
          incomeInput.value = "";
          expenseList.innerHTML = `
            <div class="expense-row">
              <input type="text" placeholder="T√™n kho·∫£n chi" class="ex-name">
              <input type="number" placeholder="S·ªë ti·ªÅn" class="ex-amount">
              <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:var(--d)">‚úï</button>
            </div>`;
        }
        renderHistory(); // C·∫≠p nh·∫≠t l·∫°i c√°c th·∫ª th·ªëng k√™
      }

      // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi th√°ng
      document.getElementById("monthYear").addEventListener("change", function () {
        updateInputsByMonth(this.value);
      });

      // C·∫≠p nh·∫≠t h√†m window.onload ƒë·ªÉ khi v·ª´a m·ªü web l√† n√≥ ki·ªÉm tra th√°ng hi·ªán t·∫°i lu√¥n
      window.onload = () => {
        const savedUrl = localStorage.getItem("google_script_url");
        if (savedUrl) document.getElementById("googleScriptUrl").value = savedUrl;

        const monthInput = document.getElementById("monthYear");
        monthInput.value = new Date().toISOString().slice(0, 7);

        // G·ªçi h√†m ki·ªÉm tra ngay khi load trang
        updateInputsByMonth(monthInput.value);
      };

      function openSheetsModal() {
        document.getElementById("sheetsModal").style.display = "block";
        document.body.style.overflow = "hidden"; // Ch·∫∑n cu·ªôn trang web khi ƒëang xem Sheets
      }

      function closeSheetsModal() {
        document.getElementById("sheetsModal").style.display = "none";
        document.body.style.overflow = "auto"; // Cho ph√©p cu·ªôn l·∫°i b√¨nh th∆∞·ªùng
      }

      // ƒê√≥ng modal khi b·∫•m ra ngo√†i v√πng tr·∫Øng
      window.onclick = function (event) {
        let modal = document.getElementById("sheetsModal");
        if (event.target == modal) {
          closeSheetsModal();
        }
        // Gi·ªØ l·∫°i logic ƒë√≥ng modal chi ti·∫øt c≈© c·ªßa m√†y
        let detailModal = document.getElementById("detailModal");
        if (event.target == detailModal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
