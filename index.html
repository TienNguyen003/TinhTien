<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Chi ti√™u ƒêa nƒÉng</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --p: #2563eb;
        --s: #22c55e;
        --d: #ef4444;
        --bg: #f1f5f9;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Roboto Slab", serif;
        background: var(--bg);
        padding: 10px;
        margin: 0;
      }
      .container {
        max-width: 900px;
        margin: 10px auto;
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      }

      /* Ph·∫ßn c·∫•u h√¨nh */
      .config-section {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
        border: 1px solid #e2e8f0;
      }
      .config-section h4 {
        margin-top: 0;
        color: #64748b;
        font-size: 14px;
      }

      /* Grid Input */
      .input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-family: inherit;
        font-size: 16px; /* Tr√°nh zoom tr√™n iOS */
      }
      .expense-row {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      .expense-row input:first-child {
        flex: 2;
      }
      .expense-row input:nth-child(2) {
        flex: 1.5;
      }

      /* Buttons */
      button {
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-family: inherit;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn-add {
        background: #f1f5f9;
        border: 1px dashed #cbd5e1;
        width: 100%;
        color: #64748b;
        margin-bottom: 20px;
      }
      .btn-main {
        background: var(--p);
        color: white;
        width: 100%;
        font-size: 16px;
        margin-bottom: 10px;
      }
      .btn-sync {
        background: var(--s);
        color: white;
        width: 100%;
      }

      /* Th·ªëng k√™ Card */
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 30px;
      }
      .stat-card {
        padding: 15px 10px;
        border-radius: 12px;
        text-align: center;
        color: white;
      }
      .bg-blue {
        background: var(--p);
      }
      .bg-green {
        background: var(--s);
      }
      .bg-indigo {
        background: #4f46e5;
      }
      .stat-card small {
        display: block;
        font-size: 11px;
        opacity: 0.9;
        margin-bottom: 5px;
      }
      .stat-card b {
        font-size: 14px;
        word-break: break-all;
      }

      /* L·ªãch s·ª≠ Table */
      .table-container {
        overflow-x: auto;
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        /* min-width: 500px;  */
      }
      th,
      td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
      }
      th {
        background: #f8fafc;
        color: #64748b;
      }
      .btn-view {
        background: #e0e7ff;
        color: #4338ca;
        padding: 6px 10px;
        font-size: 12px;
      }

      /* Modal */
      #detailModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        padding: 15px;
      }
      .modal-content {
        background: white;
        margin: 1% auto;
        padding: 20px;
        border-radius: 12px;
        max-width: 1200px;
        width: 100%;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
      }
      .close-modal {
        position: absolute;
        right: 15px;
        top: 10px;
        font-size: 28px;
        cursor: pointer;
      }

      /* --- RESPONSIVE CHO ƒêI·ªÜN THO·∫†I --- */
      @media (max-width: 600px) {
        .container {
          padding: 15px;
          border-radius: 0;
          margin: 0;
        }
        .input-group {
          grid-template-columns: 1fr;
        } /* Chuy·ªÉn nh·∫≠p li·ªáu th√†nh 1 c·ªôt */

        .summary-grid {
          grid-template-columns: 1fr; /* Card th·ªëng k√™ x·∫øp ch·ªìng l√™n nhau */
        }
        .stat-card {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px;
        }
        .stat-card small {
          margin-bottom: 0;
          font-size: 14px;
        }
        .stat-card b {
          font-size: 18px;
        }

        .expense-row {
          flex-wrap: wrap;
        }
        .expense-row input {
          flex: 1 1 40% !important;
        }
        .expense-row button {
          width: 40px;
        }

        h2 {
          font-size: 20px;
        }

        .btn-sync,
        .btn-main,
        .btn-preview {
          font-size: 10px;
        }
      }

      /* Modal xem Sheets */
      #sheetsModal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
      }
      .sheets-content {
        background: white;
        margin: 2% auto;
        padding: 10px;
        border-radius: 12px;
        width: 95%;
        max-width: 1200px;
        height: 85vh;
        position: relative;
      }
      .close-sheets {
        color: black;
        font-size: 30px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div>
        <div class="config-section">
          <h4>‚öôÔ∏è C·∫•u h√¨nh Google Sheets</h4>
          <input type="text" id="googleScriptUrl" placeholder="D√°n Web App URL v√†o ƒë√¢y..." onchange="saveConfig()" />
          <small style="display: block; margin-top: 5px; color: #94a3b8">Nh·∫•n 'ƒê·ªìng b·ªô' ƒë·ªÉ ƒë·∫©y l√™n Sheets.</small>
          <p></p>
          <input type="text" id="googleSheetUrl" placeholder="Google Sheet URL..." onchange="saveGoogleSheetUrl()" />
          <small style="display: block; margin-top: 5px; color: #94a3b8">D√°n link Sheets ƒë·ªÉ xem tr·ª±c ti·∫øp.</small>
        </div>

        <h2>üìí Qu·∫£n l√Ω Chi ti√™u</h2>

        <div class="input-group" style="grid-template-columns: 1fr">
          <div>
            <label style="font-size: 14px; color: #64748b">Th√°ng/NƒÉm</label>
            <input type="month" id="monthYear" />
          </div>
        </div>

        <h4
          style="margin-bottom: 10px; color: var(--s); cursor: pointer; display: flex; align-items: center"
          onclick="toggleSection('secttionIncome', 'iconInc')"
        >
          üí∞ C√°c kho·∫£n thu (L∆∞∆°ng, Th∆∞·ªüng...)
          <span id="iconInc" style="margin-left: 10px; transition: 0.3s; font-size: 12px">‚ñº</span>
        </h4>
        <div id="secttionIncome">
          <div id="incomeList">
            <div class="income-row" style="display: flex; gap: 8px; margin-bottom: 10px">
              <input type="text" placeholder="T√™n kho·∫£n thu" class="in-name" value="L∆∞∆°ng" />
              <input type="number" placeholder="S·ªë ti·ªÅn" class="in-amount" />
              <button onclick="this.parentElement.remove()" style="background: #f0fdf4; color: var(--s)">‚úï</button>
            </div>
          </div>
          <button class="btn-add" onclick="addIncomeRow()" style="color: var(--s); border-color: #bbf7d0">
            + Th√™m kho·∫£n thu
          </button>
        </div>

        <h4
          style="margin-bottom: 10px; color: var(--d); cursor: pointer; display: flex; align-items: center"
          onclick="toggleSection('expenseListSection', 'iconExp')"
        >
          üí∏ C√°c kho·∫£n chi ti√™u
          <span id="iconExp" style="margin-left: 10px; transition: 0.3s; font-size: 12px">‚ñº</span>
        </h4>
        <div id="expenseListSection">
          <div id="expenseList">
            <div class="expense-row">
              <input type="text" placeholder="T√™n kho·∫£n chi" class="ex-name" />
              <input type="number" placeholder="S·ªë ti·ªÅn" class="ex-amount" />
              <button onclick="this.parentElement.remove()" style="background: #fee2e2; color: var(--d)">‚úï</button>
            </div>
          </div>
          <button class="btn-add" onclick="addExpenseRow()">+ Th√™m kho·∫£n chi</button>
        </div>

        <div style="display: flex">
          <!-- <button class="btn-main" style="height: 40px" onclick="processData()">üìä L∆∞u v√†o m√°y n√†y</button> -->
          <button class="btn-sync" style="height: 40px; margin-left: 10px" onclick="syncToGoogle()">
            ‚òÅÔ∏è ƒê·ªìng b·ªô l√™n Google Sheets
          </button>
          <button
            class="btn-preview"
            onclick="openSheetsModal()"
            style="background: #64748b; color: white; width: 100%; height: 40px; margin-left: 10px"
          >
            üëÅÔ∏è Xem Sheet
          </button>
          <button
            class="btn-main"
            style="background: #f59e0b; height: 40px; margin-left: 10px"
            onclick="loadFromGoogle()"
          >
            üîÑ T·∫£i d·ªØ li·ªáu t·ª´ Sheets
          </button>
        </div>

        <div class="summary-grid">
          <div class="stat-card bg-blue"><small>D∆∞ th√°ng ch·ªçn</small><b id="monthlyRemain">0 ‚Ç´</b></div>
          <div class="stat-card bg-green">
            <small>T√≠ch l≈©y nƒÉm <span id="displayYear"></span></small><b id="yearlyRemain">0 ‚Ç´</b>
          </div>
          <div class="stat-card bg-indigo"><small>T·ªïng t√≠ch l≈©y</small><b id="totalRemain">0 ‚Ç´</b></div>
        </div>

        <h3>üìú L·ªãch s·ª≠</h3>
        <div class="table-container">
          <table id="historyTable">
            <thead>
              <tr>
                <th>Th√°ng</th>
                <th>Thu nh·∫≠p</th>
                <th>C√≤n d∆∞</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="detailModal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle" style="margin-top: 0">Chi ti·∫øt</h3>
        <table style="width: 100%">
          <thead>
            <tr>
              <th>Kho·∫£n chi</th>
              <th>S·ªë ti·ªÅn</th>
              <th>Ti·ªÅn c√≤n l·∫°i</th>
            </tr>
          </thead>
          <tbody id="modalBody"></tbody>
        </table>
        <div
          id="modalTotal"
          style="text-align: right; margin-top: 15px; font-weight: bold; font-size: 16px; line-height: 1.6"
        ></div>
      </div>
    </div>

    <div id="sheetsModal">
      <div class="sheets-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px">
          <h4 style="margin: 0 0 10px 0; color: #1e293b">B·∫£ng t√≠nh Google Sheets</h4>
          <span class="close-sheets" onclick="closeSheetsModal()">&times;</span>
        </div>
        <iframe
          id="sheetsFrame"
          style="width: 100%; height: calc(100% - 40px); border: 1px solid #e2e8f0; border-radius: 8px"
        ></iframe>
      </div>
    </div>

    <div
      id="reportSection"
      style="
        margin-top: 30px;
        padding: 20px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        display: none;
      "
    >
      <h3 style="margin-top: 0">üìä B√°o c√°o chi ti·∫øt: <span id="reportTitle"></span></h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px">
        <div>
          <h4 style="color: var(--d)">Top chi ti√™u nhi·ªÅu nh·∫•t</h4>
          <div id="topExpenses"></div>
        </div>
        <div>
          <h4 style="color: var(--p)">Ph√¢n b·ªï t√†i ch√≠nh</h4>
          <p id="savingRate"></p>
          <div id="expenseAnalysis"></div>
        </div>
      </div>
    </div>

    <script>
      // --- KH·ªûI T·∫†O & C·∫§U H√åNH ---
      window.onload = () => {
        const savedUrl = localStorage.getItem("google_script_url");
        if (savedUrl) document.getElementById("googleScriptUrl").value = savedUrl;
        const sheetUrl = localStorage.getItem("google_sheet_url");
        if (sheetUrl) document.getElementById("googleSheetUrl").value = sheetUrl;

        const monthInput = document.getElementById("monthYear");
        monthInput.value = new Date().toISOString().slice(0, 7);
        updateInputsByMonth(monthInput.value);
      };

      function toggleSection(id, iconId) {
        const list = document.getElementById(id);
        const icon = document.getElementById(iconId);

        if (list.style.display === "none") {
          list.style.display = "block";
          icon.style.transform = "rotate(0deg)"; // M≈©i t√™n ch·ªâ xu·ªëng
        } else {
          list.style.display = "none";
          icon.style.transform = "rotate(-90deg)"; // M≈©i t√™n xoay ngang khi ƒë√≥ng
        }
      }

      function saveConfig() {
        localStorage.setItem("google_script_url", document.getElementById("googleScriptUrl").value);
      }

      function saveGoogleSheetUrl() {
        localStorage.setItem("google_sheet_url", document.getElementById("googleSheetUrl").value);
      }

      // --- QU·∫¢N L√ù ROW (TH√äM/X√ìA) ---
      function addIncomeRow(name = "", amount = "", date = "") {
        const today = date || new Date().toISOString().split("T")[0]; // M·∫∑c ƒë·ªãnh l·∫•y ng√†y h√¥m nay
        const div = document.createElement("div");
        div.className = "income-row";
        div.style = "display: flex; gap: 8px; margin-bottom: 10px;";
        div.innerHTML = `
          <input type="date" class="in-date" value="${today}" style="flex: 1">
          <input type="text" placeholder="T√™n kho·∫£n thu" class="in-name" value="${name}" style="flex: 2">
          <input type="number" placeholder="S·ªë ti·ªÅn" class="in-amount" value="${amount}" style="flex: 1.5">
          <button onclick="this.parentElement.remove()" style="background:#f0fdf4; color:var(--s)">‚úï</button>`;
        document.getElementById("incomeList").appendChild(div);
      }

      function addExpenseRow(name = "", amount = "", date = "") {
        const today = date || new Date().toISOString().split("T")[0];
        const div = document.createElement("div");
        div.className = "expense-row";
        div.style = "display: flex; gap: 8px; margin-bottom: 10px;";
        div.innerHTML = `
          <input type="date" class="ex-date" value="${today}" style="flex: 1">
          <input type="text" placeholder="T√™n kho·∫£n chi" class="ex-name" value="${name}" style="flex: 2">
          <input type="number" placeholder="S·ªë ti·ªÅn" class="ex-amount" value="${amount}" style="flex: 1.5">
          <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:var(--d)">‚úï</button>`;
        document.getElementById("expenseList").appendChild(div);
      }

      // --- X·ª¨ L√ù D·ªÆ LI·ªÜU (CH·ªà D√ôNG 1 H√ÄM N√ÄY) ---
      function processData() {
        const monthYear = document.getElementById("monthYear").value;
        if (!monthYear) return alert("Vui l√≤ng ch·ªçn Th√°ng/NƒÉm!");

        // Thu th·∫≠p d·ªØ li·ªáu thu
        let incomeItems = [];
        let totalIncome = 0;
        document.querySelectorAll(".income-row").forEach((row) => {
          const date = row.querySelector(".in-date").value;
          const name = row.querySelector(".in-name").value || "Thu nh·∫≠p";
          const amt = parseFloat(row.querySelector(".in-amount").value) || 0;
          if (amt > 0) {
            incomeItems.push({ date, name, amount: amt });
            totalIncome += amt;
          }
        });

        // Thu th·∫≠p d·ªØ li·ªáu chi
        let expenseItems = [];
        let totalExp = 0;
        document.querySelectorAll(".expense-row").forEach((row) => {
          const date = row.querySelector(".ex-date").value;
          const name = row.querySelector(".ex-name").value || "Chi ti√™u";
          const amt = parseFloat(row.querySelector(".ex-amount").value) || 0;
          if (amt > 0) {
            expenseItems.push({ date, name, amount: amt });
            totalExp += amt;
          }
        });

        const remain = totalIncome - totalExp;
        let history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        const idx = history.findIndex((item) => item.date === monthYear);
        const entry = { date: monthYear, income: totalIncome, incomeItems, totalExp, remain, items: expenseItems };

        if (idx > -1) history[idx] = entry;
        else history.push(entry);

        history.sort((a, b) => new Date(a.date) - new Date(b.date));
        localStorage.setItem("expense_detail_data", JSON.stringify(history));
        renderHistory();
        alert("ƒê√£ l∆∞u d·ªØ li·ªáu chi ti·∫øt theo ng√†y!");
      }

      // --- HI·ªÇN TH·ªä ---
      function renderHistory() {
        const history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        const tbody = document.querySelector("#historyTable tbody");
        const monthInput = document.getElementById("monthYear").value;
        const selectedYear = monthInput.split("-")[0];

        document.getElementById("displayYear").innerText = selectedYear;
        tbody.innerHTML = "";

        let totalAcc = 0;
        let yearlyAcc = 0;
        let currentMonthRemain = 0;

        history.forEach((data, index) => {
          totalAcc += data.remain;
          if (data.date.startsWith(selectedYear)) yearlyAcc += data.remain;
          if (data.date === monthInput) currentMonthRemain = data.remain;

          tbody.innerHTML += `<tr>
                <td><b>${data.date}</b></td>
                <td>${data.income.toLocaleString()}</td>
                <td style="color:${data.remain >= 0 ? "green" : "red"}"><b>${data.remain.toLocaleString()}</b></td>
                <td><button class="btn-view" onclick="showDetail(${index})">üëÅ Xem</button></td>
            </tr>`;
        });

        document.getElementById("totalRemain").innerText = totalAcc.toLocaleString() + " ‚Ç´";
        document.getElementById("yearlyRemain").innerText = yearlyAcc.toLocaleString() + " ‚Ç´";
        document.getElementById("monthlyRemain").innerText = currentMonthRemain.toLocaleString() + " ‚Ç´";
      }

      function updateInputsByMonth(selectedDate) {
        const history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        const data = history.find((item) => item.date === selectedDate);
        document.getElementById("incomeList").innerHTML = "";
        document.getElementById("expenseList").innerHTML = "";

        if (data) {
          if (data.incomeItems && data.incomeItems.length > 0) {
            data.incomeItems.forEach((item) => addIncomeRow(item.name, item.amount, item.date));
          } else {
            addIncomeRow();
          }
          data.items.forEach((item) => addExpenseRow(item.name, item.amount, item.date));
        } else {
          addIncomeRow();
          addExpenseRow();
        }
        renderHistory();
        // if (typeof generateReport === "function") generateReport(selectedDate);
      }

      function showDetail(index) {
        const history = JSON.parse(localStorage.getItem("expense_detail_data"));
        const data = history[index];
        document.getElementById("modalTitle").innerText = "Chi ti·∫øt: " + data.date;
        const modalBody = document.getElementById("modalBody");
        modalBody.innerHTML = "";

        // S·∫Øp x·∫øp item theo ng√†y
        const sortedIncomes = (data.incomeItems || []).sort((a, b) => new Date(a.date) - new Date(b.date));
        const sortedExpenses = (data.items || []).sort((a, b) => new Date(a.date) - new Date(b.date));

        // H√†m t·∫°o HTML cho c√°c d√≤ng d·ªØ li·ªáu (ƒë·ªÉ t√°i s·ª≠ d·ª•ng)
        const incomeRows = sortedIncomes
          .map(
            (item) => `
              <tr class="income-item">
                <td><small>${item.date}</small><br>${item.name}</td>
                <td>${item.amount.toLocaleString()} ‚Ç´</td>
                <td>-</td>
              </tr>`,
                    )
                    .join("");

                  let runningBalance = data.income;
                  const expenseRows = sortedExpenses
                    .map((item) => {
                      runningBalance -= item.amount;
                      return `
                <tr class="expense-item">
                  <td><small>${item.date}</small><br>${item.name}</td>
                  <td>${item.amount.toLocaleString()} ‚Ç´</td>
                  <td style="color: ${runningBalance >= 0 ? "#64748b" : "red"}">${runningBalance.toLocaleString()} ‚Ç´</td>
                </tr>`;
                    })
                    .join("");

                  // T·∫°o HTML t·ªïng th·ªÉ v·ªõi c√°c h√†ng ti√™u ƒë·ªÅ c√≥ th·ªÉ Click
                  let html = `
              <tr style="cursor:pointer; background:#f0fdf4; user-select:none;">
                <td colspan="3" style="font-weight:bold; position: relative;">
                  ‚ûï KHO·∫¢N THU (${sortedIncomes.length})
                </td>
              </tr>
              ${incomeRows}

              <tr style="cursor:pointer; background:#fef2f2; user-select:none;">
                <td colspan="3" style="font-weight:bold; position: relative;">
                  ‚ûñ KHO·∫¢N CHI (${sortedExpenses.length})
                </td>
              </tr>
              ${expenseRows}
            `;

        modalBody.innerHTML = html;

        // Ph·∫ßn t·ªïng k·∫øt b√™n d∆∞·ªõi gi·ªØ nguy√™n logic c≈© c·ªßa m√†y
        document.getElementById("modalTotal").innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; text-align: center;">
            <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="font-size: 11px; color: #64748b;">THU NH·∫¨P</div>
                <div style="font-size: 15px; color: var(--p); font-weight: 700;">${data.income.toLocaleString()} ‚Ç´</div>
            </div>
            <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="font-size: 11px; color: #64748b;">T·ªîNG CHI</div>
                <div style="font-size: 15px; color: var(--d); font-weight: 700;">${data.totalExp.toLocaleString()} ‚Ç´</div>
            </div>
            <div style="grid-column: span 2; background: ${data.remain >= 0 ? "#f0fdf4" : "#fef2f2"}; padding: 12px; border-radius: 8px; border: 1px solid ${data.remain >= 0 ? "#bbf7d0" : "#fecaca"};">
                <div style="font-size: 12px; color: #64748b;">C√íN D∆Ø</div>
                <div style="font-size: 20px; color: ${data.remain >= 0 ? "var(--s)" : "var(--d)"}; font-weight: 800;">${data.remain.toLocaleString()} ‚Ç´</div>
            </div>
        </div>`;
        document.getElementById("detailModal").style.display = "block";
      }

      async function syncToGoogle() {
        processData(); // L∆∞u d·ªØ li·ªáu tr∆∞·ªõc khi ƒë·ªìng b·ªô
        const url = document.getElementById("googleScriptUrl").value;
        if (!url) return alert("Vui l√≤ng ƒëi·ªÅn Web App URL!");
        const history = JSON.parse(localStorage.getItem("expense_detail_data")) || [];
        if (!confirm("ƒê·ªìng b·ªô d·ªØ li·ªáu l√™n Google Sheets?")) return;

        try {
          await fetch(url, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(history),
            headers: { "Content-Type": "application/json" },
          });
          alert("ƒê√£ g·ª≠i d·ªØ li·ªáu! Ki·ªÉm tra Sheets nh√©.");
        } catch (e) {
          alert("L·ªói: " + e.message);
        }
      }

      async function loadFromGoogle() {
        const url = document.getElementById("googleScriptUrl").value;
        if (!url) return alert("Vui l√≤ng ƒëi·ªÅn Web App URL!");
        if (!confirm("H√†nh ƒë·ªông n√†y s·∫Ω thay th·∫ø d·ªØ li·ªáu hi·ªán t·∫°i. Ti·∫øp t·ª•c?")) return;

        try {
          const response = await fetch(url);
          let data = await response.json();

          if (data && data.length > 0) {
            // CHU·∫®N H√ìA D·ªÆ LI·ªÜU S·∫†CH S·∫º TR∆Ø·ªöC KHI L∆ØU
            const cleanData = data.map((monthData) => {
              return {
                ...monthData,
                // Ch·ªâ l·∫•y YYYY-MM (V√≠ d·ª•: 2026-02)
                date: monthData.date.split("T")[0].substring(0, 7),
                incomeItems: (monthData.incomeItems || []).map((i) => ({
                  ...i,
                  date: i.date ? i.date.split("T")[0] : "", // Ch·ªâ l·∫•y YYYY-MM-DD
                })),
                items: (monthData.items || []).map((i) => ({
                  ...i,
                  date: i.date ? i.date.split("T")[0] : "", // Ch·ªâ l·∫•y YYYY-MM-DD
                })),
              };
            });

            localStorage.setItem("expense_detail_data", JSON.stringify(cleanData));
            renderHistory();

            // Sau khi t·∫£i xong, k√≠ch ho·∫°t fill d·ªØ li·ªáu cho th√°ng ƒëang hi·ªÉn th·ªã
            const currentSelected = document.getElementById("monthYear").value;
            updateInputsByMonth(currentSelected);

            alert("ƒê√£ t·∫£i v√† ƒë·ªìng b·ªô d·ªØ li·ªáu s·∫°ch!");
          }
        } catch (e) {
          alert("L·ªói khi t·∫£i: " + e.message);
        }
      }

      // H√†m b·ªï tr·ª£ ƒë·ªÉ ƒë·∫£m b·∫£o ng√†y lu√¥n l√† YYYY-MM-DD (ƒê·ªãnh d·∫°ng m√† th·∫ª <input type="date"> c·∫ßn)
      function formatDateInput(dateStr) {
        if (!dateStr) return "";
        try {
          const d = new Date(dateStr);
          if (isNaN(d.getTime())) return dateStr;

          // L·∫•y ƒë√∫ng ng√†y, th√°ng, nƒÉm
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");

          // Tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng g·ªçn: YYYY-MM-DD
          return `${year}-${month}-${day}`;
        } catch (e) {
          return dateStr;
        }
      }

      // --- C√ÅC H√ÄM TI·ªÜN √çCH KH√ÅC ---
      function closeModal() {
        document.getElementById("detailModal").style.display = "none";
      }

      function openSheetsModal() {
        const url = localStorage.getItem("google_sheet_url");
        if (!url) return alert("Ch∆∞a c√≥ link Sheets!");
        document.getElementById("sheetsFrame").src = url;
        document.getElementById("sheetsModal").style.display = "block";
      }
      function closeSheetsModal() {
        document.getElementById("sheetsModal").style.display = "none";
      }

      document.getElementById("monthYear").addEventListener("change", function () {
        updateInputsByMonth(this.value);
      });

      window.onclick = function (e) {
        if (e.target == document.getElementById("sheetsModal")) closeSheetsModal();
        if (e.target == document.getElementById("detailModal")) closeModal();
      };
    </script>
  </body>
</html>
